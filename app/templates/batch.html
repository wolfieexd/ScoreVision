{% extends "base.html" %}

{% block title %}Batch Processing - OMR Evaluation System{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    .batch-item {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        background: #fff;
    }
    .batch-item.processing {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    .batch-item.completed {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    .batch-item.error {
        border-color: #dc3545;
        background-color: #fff5f5;
    }
    .progress-container {
        margin-top: 20px;
        display: none;
    }
    .batch-stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 10px;
        background: #fff;
    }
    .export-options {
        display: none;
        margin-top: 20px;
    }
    .status-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 10px;
    }
    .status-pending { background-color: #6c757d; }
    .status-processing { background-color: #007bff; }
    .status-completed { background-color: #28a745; }
    .status-error { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-layer-group"></i> Batch Processing</h4>
                </div>
                <div class="card-body">
                    <!-- Upload Section -->
                    <div id="uploadSection">
                        <form id="batchUploadForm" enctype="multipart/form-data">
                            <!-- OMR Files Upload -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-images text-primary"></i> 
                                    OMR Answer Sheets (Multiple files)
                                </label>
                                <div class="upload-area" id="omrUploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h5>Drop OMR sheets here or click to browse</h5>
                                    <p class="text-muted">Supported formats: JPG, PNG, TIFF, BMP</p>
                                    <p class="text-muted"><small>You can select multiple files at once</small></p>
                                    <input type="file" id="omrFiles" accept="image/*" multiple style="display: none;" required>
                                </div>
                                <div id="omrFilesList" class="file-list mt-3" style="display: none;">
                                    <h6>Selected OMR Files:</h6>
                                    <div id="omrFilesContainer"></div>
                                </div>
                            </div>

                            <!-- Answer Key Upload -->
                            <div class="mb-4">
                                <label class="form-label">
                                    <i class="fas fa-key text-success"></i> 
                                    Answer Key (Single file for all OMR sheets)
                                </label>
                                <div class="upload-area" id="answerKeyUploadArea">
                                    <i class="fas fa-file-code fa-3x text-muted mb-3"></i>
                                    <h5>Drop answer key here or click to browse</h5>
                                    <p class="text-muted">Supported formats: JSON, Excel (.xlsx, .xls)</p>
                                    <input type="file" id="answerKeyFile" accept=".json,.xlsx,.xls" style="display: none;" required>
                                </div>
                                <div id="answerKeyInfo" class="file-list mt-3" style="display: none;">
                                    <h6>Selected Answer Key:</h6>
                                    <div id="answerKeyContainer"></div>
                                </div>
                            </div>

                            <!-- Batch Settings -->
                            <div class="mb-4">
                                <h5>Batch Processing Settings</h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Parallel Processing</label>
                                        <select class="form-select" id="maxWorkers">
                                            <option value="1">1 (Sequential)</option>
                                            <option value="2" selected>2 files at once</option>
                                            <option value="4">4 files at once</option>
                                            <option value="8">8 files at once</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Quality Check</label>
                                        <select class="form-select" id="qualityCheck">
                                            <option value="standard" selected>Standard</option>
                                            <option value="strict">Strict</option>
                                            <option value="lenient">Lenient</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Auto Export</label>
                                        <select class="form-select" id="autoExport">
                                            <option value="none" selected>No auto export</option>
                                            <option value="excel">Auto export to Excel</option>
                                            <option value="csv">Auto export to CSV</option>
                                            <option value="pdf">Auto export to PDF</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid">
                                <button type="submit" id="startBatchBtn" class="btn btn-primary btn-lg" disabled>
                                    <i class="fas fa-play"></i> Start Batch Processing
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Progress Section -->
                    <div id="progressSection" class="progress-container">
                        <!-- Batch Statistics -->
                        <div class="batch-stats">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <h3 id="totalFiles" class="text-primary">0</h3>
                                    <small>Total Files</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 id="processedFiles" class="text-success">0</h3>
                                    <small>Processed</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 id="errorFiles" class="text-danger">0</h3>
                                    <small>Errors</small>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h3 id="estimatedTime" class="text-info">--</h3>
                                    <small>Est. Time Left</small>
                                </div>
                            </div>
                        </div>

                        <!-- Overall Progress -->
                        <div class="mb-4">
                            <label class="form-label">Overall Progress</label>
                            <div class="progress" style="height: 25px;">
                                <div id="overallProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%">0%</div>
                            </div>
                        </div>

                        <!-- Processing Status -->
                        <div class="mb-4">
                            <h5>Processing Status</h5>
                            <div id="batchItemsList"></div>
                        </div>

                        <!-- Control Buttons -->
                        <div class="d-flex gap-2 justify-content-center mb-4">
                            <button id="pauseBtn" class="btn btn-warning" onclick="pauseBatch()">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button id="resumeBtn" class="btn btn-success" onclick="resumeBatch()" style="display: none;">
                                <i class="fas fa-play"></i> Resume
                            </button>
                            <button id="stopBtn" class="btn btn-danger" onclick="stopBatch()">
                                <i class="fas fa-stop"></i> Stop
                            </button>
                        </div>
                    </div>

                    <!-- Results Section -->
                    <div id="resultsSection" class="export-options">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h5><i class="fas fa-check-circle"></i> Batch Processing Complete</h5>
                            </div>
                            <div class="card-body">
                                <!-- Summary Statistics -->
                                <div class="row mb-4">
                                    <div class="col-md-2 text-center">
                                        <div class="border rounded p-3">
                                            <h4 class="text-success mb-0" id="summaryProcessed">0</h4>
                                            <small>Processed</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="border rounded p-3">
                                            <h4 class="text-danger mb-0" id="summaryErrors">0</h4>
                                            <small>Errors</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="border rounded p-3">
                                            <h4 class="text-info mb-0" id="summaryAvgScore">0%</h4>
                                            <small>Avg Score</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="border rounded p-3">
                                            <h4 class="text-warning mb-0" id="summaryHighest">0%</h4>
                                            <small>Highest</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="border rounded p-3">
                                            <h4 class="text-secondary mb-0" id="summaryLowest">0%</h4>
                                            <small>Lowest</small>
                                        </div>
                                    </div>
                                    <div class="col-md-2 text-center">
                                        <div class="border rounded p-3">
                                            <h4 class="text-primary mb-0" id="summaryDuration">0s</h4>
                                            <small>Duration</small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Export Options -->
                                <h5>Export Results</h5>
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-success w-100" onclick="exportResults('excel')">
                                            <i class="fas fa-file-excel"></i> Export to Excel
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-info w-100" onclick="exportResults('csv')">
                                            <i class="fas fa-file-csv"></i> Export to CSV
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-danger w-100" onclick="exportResults('pdf')">
                                            <i class="fas fa-file-pdf"></i> Export to PDF
                                        </button>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <button class="btn btn-warning w-100" onclick="exportResults('detailed')">
                                            <i class="fas fa-chart-bar"></i> Detailed Report
                                        </button>
                                    </div>
                                </div>

                                <!-- New Batch Button -->
                                <div class="d-grid mt-4">
                                    <button class="btn btn-primary" onclick="startNewBatch()">
                                        <i class="fas fa-redo"></i> Start New Batch
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let batchState = {
        files: [],
        answerKey: null,
        processing: false,
        paused: false,
        results: [],
        startTime: null,
        batchId: null
    };

    // Setup file uploads
    setupBatchUpload();

    function setupBatchUpload() {
        // OMR Files upload
        const omrUploadArea = document.getElementById('omrUploadArea');
        const omrFiles = document.getElementById('omrFiles');
        
        omrUploadArea.addEventListener('click', () => omrFiles.click());
        omrUploadArea.addEventListener('dragover', handleDragOver);
        omrUploadArea.addEventListener('dragleave', handleDragLeave);
        omrUploadArea.addEventListener('drop', handleOMRDrop);
        omrFiles.addEventListener('change', handleOMRSelection);

        // Answer Key upload
        const answerKeyUploadArea = document.getElementById('answerKeyUploadArea');
        const answerKeyFile = document.getElementById('answerKeyFile');
        
        answerKeyUploadArea.addEventListener('click', () => answerKeyFile.click());
        answerKeyUploadArea.addEventListener('dragover', handleDragOver);
        answerKeyUploadArea.addEventListener('dragleave', handleDragLeave);
        answerKeyUploadArea.addEventListener('drop', handleAnswerKeyDrop);
        answerKeyFile.addEventListener('change', handleAnswerKeySelection);
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('dragover');
    }

    function handleOMRDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
        if (files.length > 0) {
            handleOMRFiles(files);
        }
    }

    function handleAnswerKeyDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleAnswerKeyFile(files[0]);
        }
    }

    function handleOMRSelection(e) {
        const files = Array.from(e.target.files);
        handleOMRFiles(files);
    }

    function handleAnswerKeySelection(e) {
        if (e.target.files.length > 0) {
            handleAnswerKeyFile(e.target.files[0]);
        }
    }

    function handleOMRFiles(files) {
        batchState.files = files;
        displayOMRFiles(files);
        checkFormComplete();
    }

    function handleAnswerKeyFile(file) {
        batchState.answerKey = file;
        displayAnswerKeyFile(file);
        checkFormComplete();
    }

    function displayOMRFiles(files) {
        const container = document.getElementById('omrFilesContainer');
        const filesList = document.getElementById('omrFilesList');
        
        container.innerHTML = '';
        files.forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'batch-item';
            fileItem.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-file-image text-primary"></i>
                        <strong>${file.name}</strong>
                        <small class="text-muted">(${formatFileSize(file.size)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeOMRFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            container.appendChild(fileItem);
        });
        
        filesList.style.display = files.length > 0 ? 'block' : 'none';
    }

    function displayAnswerKeyFile(file) {
        const container = document.getElementById('answerKeyContainer');
        const answerKeyInfo = document.getElementById('answerKeyInfo');
        
        container.innerHTML = `
            <div class="batch-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-file-code text-success"></i>
                        <strong>${file.name}</strong>
                        <small class="text-muted">(${formatFileSize(file.size)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeAnswerKeyFile()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        `;
        
        answerKeyInfo.style.display = 'block';
    }

    function removeOMRFile(index) {
        batchState.files.splice(index, 1);
        displayOMRFiles(batchState.files);
        checkFormComplete();
    }

    function removeAnswerKeyFile() {
        batchState.answerKey = null;
        document.getElementById('answerKeyInfo').style.display = 'none';
        document.getElementById('answerKeyFile').value = '';
        checkFormComplete();
    }

    function checkFormComplete() {
        const startBtn = document.getElementById('startBatchBtn');
        startBtn.disabled = !(batchState.files.length > 0 && batchState.answerKey);
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission
    document.getElementById('batchUploadForm').addEventListener('submit', (e) => {
        e.preventDefault();
        startBatchProcessing();
    });

    function startBatchProcessing() {
        if (batchState.files.length === 0 || !batchState.answerKey) {
            alert('Please select OMR files and answer key');
            return;
        }

        // Upload files and start processing
        uploadBatchFiles();
    }

    function uploadBatchFiles() {
        const formData = new FormData();
        
        // Add OMR files
        batchState.files.forEach((file, index) => {
            formData.append('omr_files', file);
        });
        
        // Add answer key
        formData.append('answer_key', batchState.answerKey);
        
        // Add settings
        formData.append('max_workers', document.getElementById('maxWorkers').value);
        formData.append('quality_check', document.getElementById('qualityCheck').value);
        formData.append('auto_export', document.getElementById('autoExport').value);

        fetch('/api/batch-upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                batchState.batchId = data.batch_id;
                startBatchMonitoring();
            } else {
                alert('Upload failed: ' + data.error);
            }
        })
        .catch(error => {
            alert('Upload failed: ' + error.message);
        });
    }

    function startBatchMonitoring() {
        // Switch to progress view
        document.getElementById('uploadSection').style.display = 'none';
        document.getElementById('progressSection').style.display = 'block';
        
        // Initialize progress display
        document.getElementById('totalFiles').textContent = batchState.files.length;
        document.getElementById('processedFiles').textContent = '0';
        document.getElementById('errorFiles').textContent = '0';
        
        // Create batch items
        createBatchItems();
        
        // Start processing
        batchState.processing = true;
        batchState.startTime = new Date();
        
        fetch('/api/batch-process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ batch_id: batchState.batchId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Start monitoring progress
                monitorBatchProgress();
            } else {
                alert('Failed to start processing: ' + data.error);
            }
        });
    }

    function createBatchItems() {
        const container = document.getElementById('batchItemsList');
        container.innerHTML = '';
        
        batchState.files.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'batch-item';
            item.id = `batch-item-${index}`;
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="status-icon status-pending"></span>
                        <div>
                            <strong>${file.name}</strong>
                            <div class="small text-muted">Waiting to process...</div>
                        </div>
                    </div>
                    <div id="status-${index}" class="text-muted">Pending</div>
                </div>
                <div class="progress mt-2" style="height: 5px;">
                    <div id="progress-${index}" class="progress-bar" style="width: 0%"></div>
                </div>
            `;
            container.appendChild(item);
        });
    }

    function monitorBatchProgress() {
        const checkProgress = () => {
            if (!batchState.processing) return;
            
            fetch(`/api/batch-status/${batchState.batchId}`)
                .then(response => response.json())
                .then(data => {
                    updateBatchProgress(data);
                    
                    if (data.status === 'completed' || data.status === 'error') {
                        batchState.processing = false;
                        showBatchResults(data);
                    } else {
                        setTimeout(checkProgress, 1000);
                    }
                })
                .catch(error => {
                    console.error('Error checking progress:', error);
                    setTimeout(checkProgress, 2000);
                });
        };
        
        checkProgress();
    }

    function updateBatchProgress(data) {
        // Update overall statistics
        document.getElementById('processedFiles').textContent = data.processed || 0;
        document.getElementById('errorFiles').textContent = data.errors || 0;
        
        const progress = (data.processed || 0) / batchState.files.length * 100;
        const progressBar = document.getElementById('overallProgress');
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.round(progress) + '%';
        
        // Update estimated time
        if (data.estimated_time_left) {
            document.getElementById('estimatedTime').textContent = formatDuration(data.estimated_time_left);
        }
        
        // Update individual file statuses
        if (data.file_statuses) {
            data.file_statuses.forEach((status, index) => {
                updateFileStatus(index, status);
            });
        }
    }

    function updateFileStatus(index, status) {
        const item = document.getElementById(`batch-item-${index}`);
        const statusIcon = item.querySelector('.status-icon');
        const statusText = document.getElementById(`status-${index}`);
        const progressBar = document.getElementById(`progress-${index}`);
        
        // Update status icon and text
        statusIcon.className = `status-icon status-${status.status}`;
        statusText.textContent = status.status.charAt(0).toUpperCase() + status.status.slice(1);
        
        // Update progress bar
        progressBar.style.width = (status.progress || 0) + '%';
        
        // Update item styling
        item.className = `batch-item ${status.status}`;
    }

    function showBatchResults(data) {
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
        
        // Update summary statistics
        document.getElementById('summaryProcessed').textContent = data.processed || 0;
        document.getElementById('summaryErrors').textContent = data.errors || 0;
        document.getElementById('summaryAvgScore').textContent = (data.average_score || 0).toFixed(1) + '%';
        document.getElementById('summaryHighest').textContent = (data.highest_score || 0).toFixed(1) + '%';
        document.getElementById('summaryLowest').textContent = (data.lowest_score || 0).toFixed(1) + '%';
        
        const duration = new Date() - batchState.startTime;
        document.getElementById('summaryDuration').textContent = formatDuration(duration / 1000);
        
        batchState.results = data.results || [];
    }

    function formatDuration(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}m ${secs}s`;
    }

    function pauseBatch() {
        fetch(`/api/batch-pause/${batchState.batchId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    batchState.paused = true;
                    document.getElementById('pauseBtn').style.display = 'none';
                    document.getElementById('resumeBtn').style.display = 'inline-block';
                }
            });
    }

    function resumeBatch() {
        fetch(`/api/batch-resume/${batchState.batchId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    batchState.paused = false;
                    document.getElementById('pauseBtn').style.display = 'inline-block';
                    document.getElementById('resumeBtn').style.display = 'none';
                }
            });
    }

    function stopBatch() {
        if (confirm('Are you sure you want to stop the batch processing?')) {
            fetch(`/api/batch-stop/${batchState.batchId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        batchState.processing = false;
                        showBatchResults(data);
                    }
                });
        }
    }

    function exportResults(format) {
        const url = `/api/batch-export/${batchState.batchId}?format=${format}`;
        window.open(url, '_blank');
    }

    function startNewBatch() {
        // Reset state
        batchState = {
            files: [],
            answerKey: null,
            processing: false,
            paused: false,
            results: [],
            startTime: null,
            batchId: null
        };
        
        // Reset UI
        document.getElementById('uploadSection').style.display = 'block';
        document.getElementById('progressSection').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'none';
        
        // Clear forms
        document.getElementById('omrFiles').value = '';
        document.getElementById('answerKeyFile').value = '';
        document.getElementById('omrFilesList').style.display = 'none';
        document.getElementById('answerKeyInfo').style.display = 'none';
        
        checkFormComplete();
    }
</script>
{% endblock %}