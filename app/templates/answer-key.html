{% extends "base.html" %}

{% block title %}Answer Key Management - OMR Evaluation System{% endblock %}

{% block extra_css %}
<style>
    .answer-key-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .answer-key-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .answer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin: 15px 0;
    }
    .answer-item {
        text-align: center;
        padding: 8px 4px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        background: white;
        font-weight: bold;
    }
    .answer-item.option-a { background-color: #e3f2fd; border-color: #2196f3; }
    .answer-item.option-b { background-color: #e8f5e8; border-color: #4caf50; }
    .answer-item.option-c { background-color: #fff3e0; border-color: #ff9800; }
    .answer-item.option-d { background-color: #fce4ec; border-color: #e91e63; }
    .answer-item.option-e { background-color: #f3e5f5; border-color: #9c27b0; }
    
    .create-form {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .answer-editor {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 15px 0;
    }
    
    .question-row {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        background: #f8f9fa;
    }
    
    .question-number {
        min-width: 40px;
        font-weight: bold;
        color: #495057;
    }
    
    .answer-options {
        display: flex;
        gap: 10px;
        margin-left: 15px;
        flex: 1;
    }
    
    .answer-option {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        background: white;
    }
    
    .upload-area:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    
    .upload-area.dragover {
        border-color: #007bff;
        background-color: #e3f2fd;
    }
    
    .validation-result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 8px;
    }
    
    .validation-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    
    .validation-error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    
    .answer-key-actions {
        position: absolute;
        top: 10px;
        right: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .answer-key-card:hover .answer-key-actions {
        opacity: 1;
    }
    
    @media (max-width: 768px) {
        .answer-grid {
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 5px;
            padding: 10px;
        }
        
        .answer-options {
            flex-direction: column;
            gap: 5px;
        }
        
        .question-row {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-key text-primary"></i> Answer Key Management</h2>
        <div>
            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createAnswerKeyModal">
                <i class="fas fa-plus"></i> Create New Answer Key
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadAnswerKeyModal">
                <i class="fas fa-upload"></i> Upload Answer Key
            </button>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-file-excel fa-3x text-success mb-3"></i>
                    <h6>Excel Template</h6>
                    <button class="btn btn-outline-success btn-sm" onclick="downloadExcelTemplate()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-file-code fa-3x text-info mb-3"></i>
                    <h6>JSON Template</h6>
                    <button class="btn btn-outline-info btn-sm" onclick="downloadJSONTemplate()">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-check-circle fa-3x text-warning mb-3"></i>
                    <h6>Validate Answer Key</h6>
                    <button class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#validateAnswerKeyModal">
                        <i class="fas fa-clipboard-check"></i> Validate
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <i class="fas fa-history fa-3x text-secondary mb-3"></i>
                    <h6>Recent Keys</h6>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadRecentKeys()">
                        <i class="fas fa-clock"></i> View Recent
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Answer Keys List -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> Saved Answer Keys</h5>
                <div class="input-group" style="width: 300px;">
                    <input type="text" class="form-control" id="searchAnswerKeys" placeholder="Search answer keys...">
                    <button class="btn btn-outline-secondary" onclick="searchAnswerKeys()">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div id="answerKeysList" class="row">
                <!-- Answer keys will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Create Answer Key Modal -->
<div class="modal fade" id="createAnswerKeyModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create New Answer Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createAnswerKeyForm">
                    <!-- Basic Information -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Answer Key Name</label>
                            <input type="text" class="form-control" id="answerKeyName" required placeholder="e.g., Math Final Exam 2024">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Number of Questions</label>
                            <input type="number" class="form-control" id="numQuestions" min="1" max="200" value="20" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Answer Options</label>
                            <select class="form-select" id="answerOptions" required>
                                <option value="4">A, B, C, D</option>
                                <option value="5">A, B, C, D, E</option>
                                <option value="3">A, B, C</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="subject" placeholder="e.g., Mathematics">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Grade/Class</label>
                            <input type="text" class="form-control" id="gradeClass" placeholder="e.g., Grade 10">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Exam Date</label>
                            <input type="date" class="form-control" id="examDate">
                        </div>
                    </div>

                    <!-- Generate Questions Button -->
                    <div class="text-center mb-3">
                        <button type="button" class="btn btn-primary" onclick="generateQuestions()">
                            <i class="fas fa-magic"></i> Generate Question Template
                        </button>
                    </div>

                    <!-- Answer Editor -->
                    <div id="answerEditor" class="answer-editor" style="display: none;">
                        <h6><i class="fas fa-edit"></i> Answer Key Editor</h6>
                        <div class="mb-3">
                            <small class="text-muted">Click on the correct answer for each question</small>
                        </div>
                        <div id="questionsContainer"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveAnswerKeyBtn" onclick="saveAnswerKey()" disabled>
                    <i class="fas fa-save"></i> Save Answer Key
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Answer Key Modal -->
<div class="modal fade" id="uploadAnswerKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload"></i> Upload Answer Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="uploadArea">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Drop answer key file here or click to browse</h5>
                    <p class="text-muted">Supported formats: JSON, Excel (.xlsx, .xls)</p>
                    <input type="file" id="answerKeyFileUpload" accept=".json,.xlsx,.xls" style="display: none;">
                </div>
                
                <!-- File Information -->
                <div id="fileInfo" style="display: none;" class="mt-3">
                    <div class="card">
                        <div class="card-body">
                            <h6><i class="fas fa-file"></i> File Information</h6>
                            <div id="fileDetails"></div>
                        </div>
                    </div>
                </div>

                <!-- Validation Results -->
                <div id="validationResults"></div>

                <!-- Preview -->
                <div id="answerKeyPreview" style="display: none;" class="mt-3">
                    <h6><i class="fas fa-eye"></i> Answer Key Preview</h6>
                    <div id="previewContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="importAnswerKeyBtn" onclick="importAnswerKey()" disabled>
                    <i class="fas fa-file-import"></i> Import Answer Key
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Validate Answer Key Modal -->
<div class="modal fade" id="validateAnswerKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-clipboard-check"></i> Validate Answer Key</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="validateUploadArea">
                    <i class="fas fa-file-search fa-3x text-muted mb-3"></i>
                    <h5>Drop answer key file here to validate</h5>
                    <p class="text-muted">Supported formats: JSON, Excel (.xlsx, .xls)</p>
                    <input type="file" id="validateFileUpload" accept=".json,.xlsx,.xls" style="display: none;">
                </div>
                
                <div id="validationReport" style="display: none;" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentAnswerKey = {
        name: '',
        questions: 0,
        options: 4,
        answers: {},
        metadata: {}
    };

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadAnswerKeys();
        setupFileUploads();
    });

    function setupFileUploads() {
        // Create Answer Key upload
        setupUploadArea('uploadArea', 'answerKeyFileUpload', handleAnswerKeyUpload);
        
        // Validate Answer Key upload
        setupUploadArea('validateUploadArea', 'validateFileUpload', handleValidationUpload);
    }

    function setupUploadArea(areaId, inputId, handler) {
        const area = document.getElementById(areaId);
        const input = document.getElementById(inputId);
        
        area.addEventListener('click', () => input.click());
        area.addEventListener('dragover', (e) => {
            e.preventDefault();
            area.classList.add('dragover');
        });
        area.addEventListener('dragleave', () => {
            area.classList.remove('dragover');
        });
        area.addEventListener('drop', (e) => {
            e.preventDefault();
            area.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handler(e.dataTransfer.files[0]);
            }
        });
        input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handler(e.target.files[0]);
            }
        });
    }

    function loadAnswerKeys() {
        fetch('/api/answer-keys')
            .then(response => response.json())
            .then(data => {
                displayAnswerKeys(data.answer_keys || []);
            })
            .catch(error => {
                console.error('Error loading answer keys:', error);
                displayAnswerKeys([]);
            });
    }

    function displayAnswerKeys(answerKeys) {
        const container = document.getElementById('answerKeysList');
        
        if (answerKeys.length === 0) {
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="fas fa-key fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No answer keys found</h5>
                    <p class="text-muted">Create or upload your first answer key to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = answerKeys.map(key => `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="card answer-key-card position-relative h-100" onclick="viewAnswerKey('${key.id}')">
                    <div class="answer-key-actions">
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editAnswerKey('${key.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadAnswerKey('${key.id}')" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteAnswerKey('${key.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${key.name}</h6>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-question-circle"></i> ${key.questions} questions |
                                <i class="fas fa-list"></i> ${key.options} options
                            </small>
                        </div>
                        ${key.subject ? `<div class="mb-1"><small><strong>Subject:</strong> ${key.subject}</small></div>` : ''}
                        ${key.grade ? `<div class="mb-1"><small><strong>Grade:</strong> ${key.grade}</small></div>` : ''}
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-calendar"></i> ${new Date(key.created).toLocaleDateString()}
                            </small>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="answer-grid" style="grid-template-columns: repeat(10, 1fr); gap: 2px; padding: 5px;">
                            ${Object.entries(key.answers || {}).slice(0, 20).map(([q, a]) => 
                                `<div class="answer-item option-${['a','b','c','d','e'][a]}" style="padding: 2px; font-size: 0.7em;">${q}</div>`
                            ).join('')}
                            ${Object.keys(key.answers || {}).length > 20 ? '<div class="text-muted" style="padding: 2px; font-size: 0.7em;">...</div>' : ''}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function generateQuestions() {
        const numQuestions = parseInt(document.getElementById('numQuestions').value);
        const numOptions = parseInt(document.getElementById('answerOptions').value);
        
        if (!numQuestions || numQuestions < 1 || numQuestions > 200) {
            alert('Please enter a valid number of questions (1-200)');
            return;
        }

        currentAnswerKey.questions = numQuestions;
        currentAnswerKey.options = numOptions;
        currentAnswerKey.answers = {};

        const container = document.getElementById('questionsContainer');
        const optionLabels = ['A', 'B', 'C', 'D', 'E'];
        
        container.innerHTML = '';
        
        for (let i = 1; i <= numQuestions; i++) {
            const questionRow = document.createElement('div');
            questionRow.className = 'question-row';
            
            questionRow.innerHTML = `
                <div class="question-number">Q${i}</div>
                <div class="answer-options">
                    ${optionLabels.slice(0, numOptions).map((option, index) => `
                        <div class="answer-option">
                            <input type="radio" name="q${i}" value="${index}" id="q${i}_${index}" 
                                   onchange="setAnswer(${i}, ${index})">
                            <label for="q${i}_${index}" class="form-check-label">${option}</label>
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.appendChild(questionRow);
        }
        
        document.getElementById('answerEditor').style.display = 'block';
        updateSaveButton();
    }

    function setAnswer(question, answer) {
        currentAnswerKey.answers[question] = answer;
        updateSaveButton();
    }

    function updateSaveButton() {
        const saveBtn = document.getElementById('saveAnswerKeyBtn');
        const answeredQuestions = Object.keys(currentAnswerKey.answers).length;
        const totalQuestions = currentAnswerKey.questions;
        
        saveBtn.disabled = answeredQuestions !== totalQuestions;
        
        if (answeredQuestions > 0) {
            saveBtn.innerHTML = `<i class="fas fa-save"></i> Save Answer Key (${answeredQuestions}/${totalQuestions})`;
        }
    }

    function saveAnswerKey() {
        const name = document.getElementById('answerKeyName').value;
        const subject = document.getElementById('subject').value;
        const gradeClass = document.getElementById('gradeClass').value;
        const examDate = document.getElementById('examDate').value;
        
        if (!name) {
            alert('Please enter a name for the answer key');
            return;
        }

        const answerKeyData = {
            name: name,
            questions: currentAnswerKey.questions,
            options: currentAnswerKey.options,
            answers: currentAnswerKey.answers,
            metadata: {
                subject: subject,
                grade: gradeClass,
                exam_date: examDate,
                created: new Date().toISOString()
            }
        };

        fetch('/api/answer-keys', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(answerKeyData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Answer key saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('createAnswerKeyModal')).hide();
                loadAnswerKeys();
                resetCreateForm();
            } else {
                alert('Error saving answer key: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving answer key: ' + error.message);
        });
    }

    function resetCreateForm() {
        document.getElementById('createAnswerKeyForm').reset();
        document.getElementById('answerEditor').style.display = 'none';
        document.getElementById('saveAnswerKeyBtn').disabled = true;
        currentAnswerKey = { name: '', questions: 0, options: 4, answers: {}, metadata: {} };
    }

    function handleAnswerKeyUpload(file) {
        const fileInfo = document.getElementById('fileInfo');
        const fileDetails = document.getElementById('fileDetails');
        
        fileDetails.innerHTML = `
            <p><strong>Filename:</strong> ${file.name}</p>
            <p><strong>Size:</strong> ${formatFileSize(file.size)}</p>
            <p><strong>Type:</strong> ${file.type}</p>
        `;
        fileInfo.style.display = 'block';

        // Upload and validate file
        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/upload-answer-key', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            displayValidationResults(data, 'validationResults');
            if (data.success) {
                displayAnswerKeyPreview(data.data);
                document.getElementById('importAnswerKeyBtn').disabled = false;
            }
        })
        .catch(error => {
            displayValidationResults({ success: false, error: error.message }, 'validationResults');
        });
    }

    function handleValidationUpload(file) {
        const formData = new FormData();
        formData.append('file', file);

        fetch('/api/validate-answer-key', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            displayValidationReport(data);
        })
        .catch(error => {
            displayValidationReport({ success: false, error: error.message });
        });
    }

    function displayValidationResults(data, containerId) {
        const container = document.getElementById(containerId);
        
        if (data.success) {
            container.innerHTML = `
                <div class="validation-result validation-success">
                    <h6><i class="fas fa-check-circle"></i> Validation Successful</h6>
                    <p>Answer key is valid and ready to import.</p>
                    ${data.warnings ? `<div class="mt-2"><strong>Warnings:</strong><ul>${data.warnings.map(w => `<li>${w}</li>`).join('')}</ul></div>` : ''}
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="validation-result validation-error">
                    <h6><i class="fas fa-exclamation-triangle"></i> Validation Failed</h6>
                    <p><strong>Error:</strong> ${data.error}</p>
                    ${data.details ? `<div class="mt-2"><strong>Details:</strong><ul>${data.details.map(d => `<li>${d}</li>`).join('')}</ul></div>` : ''}
                </div>
            `;
        }
    }

    function displayValidationReport(data) {
        const container = document.getElementById('validationReport');
        container.style.display = 'block';
        
        if (data.success) {
            const validation = data.validation;
            container.innerHTML = `
                <div class="validation-result ${validation.valid ? 'validation-success' : 'validation-error'}">
                    <h6><i class="fas fa-clipboard-check"></i> Validation Report</h6>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Questions:</strong> ${validation.question_count || 'N/A'}
                        </div>
                        <div class="col-md-3">
                            <strong>Options:</strong> ${validation.option_count || 'N/A'}
                        </div>
                        <div class="col-md-3">
                            <strong>Format:</strong> ${validation.format || 'N/A'}
                        </div>
                        <div class="col-md-3">
                            <strong>Status:</strong> <span class="badge ${validation.valid ? 'bg-success' : 'bg-danger'}">${validation.valid ? 'Valid' : 'Invalid'}</span>
                        </div>
                    </div>
                    
                    ${validation.errors && validation.errors.length > 0 ? `
                        <div class="mb-3">
                            <strong class="text-danger">Errors:</strong>
                            <ul class="mb-0">
                                ${validation.errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${validation.warnings && validation.warnings.length > 0 ? `
                        <div class="mb-3">
                            <strong class="text-warning">Warnings:</strong>
                            <ul class="mb-0">
                                ${validation.warnings.map(warning => `<li>${warning}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${validation.suggestions && validation.suggestions.length > 0 ? `
                        <div>
                            <strong class="text-info">Suggestions:</strong>
                            <ul class="mb-0">
                                ${validation.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        } else {
            container.innerHTML = `
                <div class="validation-result validation-error">
                    <h6><i class="fas fa-exclamation-triangle"></i> Validation Failed</h6>
                    <p><strong>Error:</strong> ${data.error}</p>
                </div>
            `;
        }
    }

    function displayAnswerKeyPreview(answerKeyData) {
        const container = document.getElementById('answerKeyPreview');
        const content = document.getElementById('previewContent');
        
        const optionLabels = ['A', 'B', 'C', 'D', 'E'];
        
        content.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h6>${answerKeyData.metadata?.title || 'Answer Key Preview'}</h6>
                    <div class="mb-3">
                        <small class="text-muted">
                            Questions: ${Object.keys(answerKeyData.answers).length} | 
                            Options: ${answerKeyData.metadata?.choices || 'N/A'}
                        </small>
                    </div>
                    <div class="answer-grid">
                        ${Object.entries(answerKeyData.answers).slice(0, 50).map(([q, a]) => 
                            `<div class="answer-item option-${optionLabels[a].toLowerCase()}">${q}: ${optionLabels[a]}</div>`
                        ).join('')}
                        ${Object.keys(answerKeyData.answers).length > 50 ? 
                            `<div class="text-center text-muted">... and ${Object.keys(answerKeyData.answers).length - 50} more</div>` : ''}
                    </div>
                </div>
            </div>
        `;
        
        container.style.display = 'block';
    }

    function importAnswerKey() {
        // Implementation for importing the uploaded answer key
        alert('Answer key imported successfully!');
        bootstrap.Modal.getInstance(document.getElementById('uploadAnswerKeyModal')).hide();
        loadAnswerKeys();
    }

    function viewAnswerKey(id) {
        // Implementation for viewing answer key details
        window.location.href = `/answer-key/${id}`;
    }

    function editAnswerKey(id) {
        // Implementation for editing answer key
        alert('Edit functionality coming soon!');
    }

    function deleteAnswerKey(id) {
        if (confirm('Are you sure you want to delete this answer key?')) {
            fetch(`/api/answer-keys/${id}`, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadAnswerKeys();
                    } else {
                        alert('Error deleting answer key: ' + data.error);
                    }
                });
        }
    }

    function downloadAnswerKey(id) {
        window.open(`/api/answer-keys/${id}/download`, '_blank');
    }

    function downloadExcelTemplate() {
        window.open('/api/download-excel-template', '_blank');
    }

    function downloadJSONTemplate() {
        const template = {
            "metadata": {
                "title": "Sample Answer Key",
                "questions": 20,
                "choices": 4,
                "created": new Date().toISOString()
            },
            "answers": {}
        };
        
        // Generate sample answers
        for (let i = 1; i <= 20; i++) {
            template.answers[i] = Math.floor(Math.random() * 4);
        }
        
        const dataStr = JSON.stringify(template, null, 2);
        const dataBlob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = 'answer_key_template.json';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function searchAnswerKeys() {
        const query = document.getElementById('searchAnswerKeys').value;
        // Implementation for searching answer keys
        console.log('Searching for:', query);
    }

    function loadRecentKeys() {
        // Implementation for loading recent keys
        alert('Recent keys functionality coming soon!');
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
</script>
{% endblock %}